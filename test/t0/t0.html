<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>IndexedDB CRUD Demo</title>
</head>
<body>
<h1>IndexedDB 基础 CRUD 示例</h1>
<p>打开控制台查看输出（F12）。</p>

<script>
// ----------- 小工具：把 IDBRequest 转成 Promise，写起来更直观 -----------
function idb(req) {
  return new Promise((resolve, reject) => {
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

// 打开/创建数据库，顺便在 onupgradeneeded 里建 object store 和索引
function openDB(dbName = "str_5756", version = 1) {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(dbName, version);

    req.onupgradeneeded = (event) => {
      const db = req.result;
      // 如果已存在先避免重复创建
      if (!db.objectStoreNames.contains("os0")) {
        // keyPath 使用 id，自增。也可以用 { keyPath: 'id', autoIncrement: true }
        const store = db.createObjectStore("os0", { keyPath: "id", autoIncrement: true });
        // 建一个基于 name 的索引，允许重复值
        store.createIndex("idx_name", "name", { unique: false });
      }
      console.log("[upgrade] 数据库结构已初始化/升级到版本", event.newVersion);
    };

    req.onsuccess = () => resolve(req.result);
    req.onerror   = () => reject(req.error);
  });
}

// 便捷函数：开启事务并拿到 store
function getStore(db, mode = "readonly") {
  const tx = db.transaction("os0", mode);
  return { tx, store: tx.objectStore("os0") };
}

(async () => {
  try {
    const db = await openDB("str_5756", 1);

    // ---------- Create（增）----------
    {
      const { tx, store } = getStore(db, "readwrite");
      const id1 = await idb(store.add({ name: "Alice", age: 30 }));
      const id2 = await idb(store.add({ name: "Bob",   age: 24 }));
      const id3 = await idb(store.add({ name: "Alice", age: 31, city: "SG" }));
      await idb(tx.done ?? tx); // 某些实现没有 tx.done，这里等价等事务结束
      console.log("[CREATE] 新增记录 id =", id1, id2, id3);
    }

    // ---------- Read（查）----------
    {
      const { tx, store } = getStore(db, "readonly");
      // 读取某个主键（假设我们想看看 id=1）
      const one = await idb(store.get(1));
      // 全表读取
      const all = await idb(store.getAll());
      // 使用索引按 name 精确查询第一条
      const idx = store.index("idx_name");
      const firstAlice = await idb(idx.get("Alice"));
      await idb(tx.done ?? tx);
      console.log("[READ] get(1) =", one);
      console.log("[READ] getAll() 共", all.length, "条 =", all);
      console.log("[READ] index('idx_name').get('Alice') =", firstAlice);
    }

    // ---------- Update（改）----------
    {
      const { tx, store } = getStore(db, "readwrite");
      // 先取出后更新，或直接 put 完整对象（含 id）
      const target = await idb(store.get(2)); // 假设更新 id=2 (Bob)
      if (target) {
        target.age = 25; // 年龄 +1
        await idb(store.put(target)); // put 会按 keyPath 覆盖更新
        console.log("[UPDATE] 已更新 id=2 ->", target);
      }
      await idb(tx.done ?? tx);
    }

    // ---------- Delete（删）----------
    {
      const { tx, store } = getStore(db, "readwrite");
      await idb(store.delete(1)); // 删除主键为 1 的记录
      await idb(tx.done ?? tx);
      console.log("[DELETE] 已删除 id=1");
    }

    // ---------- 游标遍历（可选：做“查询所有并处理”的另一种方式）----------
    {
      const { tx, store } = getStore(db, "readonly");
      const cursorReq = store.openCursor(); // 也可以传 range 或者用索引 .index('idx_name').openCursor()
      const results = [];
      await new Promise((resolve, reject) => {
        cursorReq.onerror = () => reject(cursorReq.error);
        cursorReq.onsuccess = () => {
          const cursor = cursorReq.result;
          if (cursor) {
            results.push(cursor.value);
            cursor.continue(); // 继续下一个
          } else {
            resolve();
          }
        };
      });
      await idb(tx.done ?? tx);
      console.log("[CURSOR] 遍历剩余记录，共", results.length, "条 =", results);
    }

    // ---------- 其他常用操作（演示：count/clear）----------
    {
      const { tx, store } = getStore(db, "readwrite");
      const count = await idb(store.count());
      console.log("[UTIL] 当前记录总数 count() =", count);
      // 如需清空表：
      // await idb(store.clear());
      await idb(tx.done ?? tx);
    }

    console.log("✅ 所有操作完成。");

  } catch (err) {
    console.error("❌ IndexedDB 出错：", err);
  }
})();
</script>
</body>
</html>
